---
title: "DEC Dashboard"
author: "Taylor Mack"
date: "3/10/2023"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r global, include=FALSE}
library(flexdashboard)
library(shinydashboard)
library(tidyverse)
library(ggplot2)
library(stringr)
user_path <- "/Users/taylor/Documents/OMSBA 5210/DEC/OMSBA-5210-DEC"


game_reviews <- read.csv(paste0(user_path,"/Data/game_reviews.csv"))
global_sales <- read.csv(paste0(user_path,"/Data/global_sales.csv"))
pc_game_sales <- read.csv(paste0(user_path,"/Data/pc_game_sales.csv"))
twitch_game_data <- read.csv(paste0(user_path,"/Data/twitch_game_data.csv"))
twitch_global_data <- read.csv(paste0(user_path,"/Data/twitch_global_data.csv"))

data_set <- merge(x=global_sales,y=game_reviews,by.x="Name",by.y="name")

options(scipen = 999)

game_reviews_temp <- game_reviews %>% mutate(user_review = as.numeric(user_review) * 10) %>%
                                      mutate(platform = str_trim(platform)) %>%
                                      mutate(name = str_trim(name)) %>% drop_na()

global_sales_temp <- global_sales %>% filter(Year >= 2010) %>% filter(Year != "N/A") %>% 
                     mutate(handheld_console = 
                        ifelse(Platform %in% c("DS","3DS","PSP","PSV","GB"),TRUE,FALSE)) %>%
                     mutate(NA_Sales = NA_Sales * 1000000) %>%
                     mutate(EU_Sales = EU_Sales * 1000000) %>%
                     mutate(JP_Sales = JP_Sales * 1000000) %>%
                     mutate(Other_Sales = Other_Sales * 1000000) %>%
                     mutate(Global_Sales = Global_Sales * 1000000) %>%
                     mutate(Platform = case_when(
                       Platform == "X360" ~ "Xbox 360",
                       Platform == "PS3" ~ "PlayStation 3",
                       Platform == "PS4" ~ "PlayStation 4",
                       Platform == "XOne" ~ "Xbox One",
                       Platform == "WiiU" ~ "Wii U",
                       Platform == "PS2" ~ "PlayStation 2",
                       Platform == "GBA" ~ "Game Boy Advance",
                       Platform == "PSV" ~ "PlayStation Vita",
                       Platform == "PS" ~ "PlayStation",
                       Platform == "XB" ~ "Xbox",
                       Platform == "GC" ~ "GameCube",
                       Platform == "GB" ~ "Game Boy",
                       Platform == "GC" ~ "GameCube",
                       Platform == "N64" ~ "Nintendo 64",
                       TRUE ~ Platform
                     )) %>% mutate(Name = str_trim(Name)) %>% drop_na(c(Year,Platform))
twitch_game_data_temp <- twitch_game_data %>% mutate(Game = str_trim(Game)) %>%
                         filter(Game != "") %>%
                         mutate(Hours_watched = as.numeric(str_trim(sub("\\(.*","",Hours_watched)))) %>%
                         mutate(Hours_Streamed = str_trim(sub("\\(.*","",Hours_Streamed))) %>%
                         mutate(Peak_viewers = str_trim(sub("\\(.*","",Peak_viewers))) %>%
                         mutate(Peak_channels = str_trim(sub("\\(.*","",Peak_channels))) %>%
                         mutate(Streamers = str_trim(sub("\\(.*","",Streamers))) %>%
                         mutate(Avg_viewers = str_trim(sub("\\(.*","",Avg_viewers))) %>%
                         mutate(Avg_channels = str_trim(sub("\\(.*","",Avg_channels))) %>%
                         mutate(Avg_viewer_ratio = str_trim(sub("\\(.*","",Avg_viewer_ratio))) %>%
                         mutate(Hours_Streamed = as.numeric(gsub("\\D","",Hours_Streamed))) %>%
                         group_by(Game) %>% 
                         mutate(total_hours_watched = sum(Hours_watched)) %>%
                         mutate(total_hours_streamed = sum(as.numeric(Hours_Streamed))) %>%
                         mutate(avg_peak_viewers = mean(as.numeric(Peak_viewers))) %>%
                         mutate(avg_peak_channels = mean(as.numeric(Peak_channels))) %>%
                         mutate(avg_streamers = mean(as.numeric(Streamers))) %>%
                         mutate(Avg_viewers = mean(as.numeric(Avg_viewers))) %>%
                         mutate(Avg_channels = mean(as.numeric(Avg_channels))) %>%
                         mutate(Avg_viewer_ratio = mean(as.numeric(Avg_viewer_ratio))) %>%
                         select(c("Game","total_hours_watched","total_hours_streamed",
                                  "avg_peak_viewers","avg_peak_channels","avg_streamers","Avg_viewers",
                                  "Avg_channels","Avg_viewer_ratio")) %>% unique() %>% ungroup()

data_set <- left_join(x=global_sales_temp,y=game_reviews_temp,by=c("Name"="name","Platform"="platform"))
data_set <- left_join(x=data_set,y=twitch_game_data_temp,by=c("Name"="Game"))
```

Column {.sidebar}
-----------------------------------------------------------------------

### Filters

```{r}
checkboxGroupInput("radio","Choose Region:",c("North America"="NA_Sales",
                      "Europe" = "EU_Sales",
                      "Japan" = "JP_Sales",
                      "Other" = "Other_Sales"))



```

Column {.tabset}
-----------------------------------------------------------------------

###Tab 1 

```{r tabsets, echo=FALSE}
library(treemap)
library(d3treeR)


renderD3tree2({
tree_data_set <- data_set %>% select(-c("Platform","Rank")) %>% unique() %>%
                 gather("Region","Sales",c("NA_Sales","EU_Sales","JP_Sales","Other_Sales")) %>%
                 group_by(Name,Region) %>%
                 select(Name,Genre,Region,Sales) %>% mutate(Region_updated= Region) %>% unique() %>%
                  mutate(Region = case_when(
                       Region == "NA_Sales" ~ "North America",
                       Region == "EU_Sales" ~ "Europe",
                       Region == "JP_Sales" ~ "Japan",
                       Region == "Other_Sales" ~ "Other",
                       TRUE ~ Region))
              
d3tree2(treemap(tree_data_set,index=c("Region_updated","Genre"),vSize="Sales",title= "Sales by Region and Genre"),rootname="Sales by Region and Genre")
})

```

Note the use of the `height` parameter to determine how much vertical space the embedded application should occupy.

You can also use the `shinyApp` function to define an application inline rather then in an external directory.

In all of R code chunks above the `echo = FALSE` attribute is used. This is to prevent the R code within the chunk from rendering in the document alongside the Shiny components.



